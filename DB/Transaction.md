# Transaction

> 트랜잭션은 작업의 **완전성** 보장
>
> 즉, 논리적인 작업 셋을 완벽하게 처리 하지 못할 경우 원 상태로 복구해 작업 일부만 적용되는 현상이 발생하지 않게 하는 것



### 트랜잭션과 Lock

- Lock은 동시성을 제어하기 위한 기능

- 트렌젝션은 데이터의 정합성을 보장하기 위한 기능



### 특성

1. 원자성(Atomicity)

아무 문제 없을 때만 모든 작업이 수행

2. 일관성(Consistency)

트랜젝션 완료 후에도 데이터 일관성 보장해야 함

3. 고립성(Isolation)

각각의 트랜젝션은 서로 독립적으로 수행되어야 한다.

4. 지속성(Durability)

트랜젝션이 정상적으로 종료되면 영구적으로 DB에 작업 결과가 저장되어야 한다.



### 상태

![image-20200925234002057](C:\Users\Woo\AppData\Roaming\Typora\typora-user-images\image-20200925234002057.png)

#### Active

트랜젝션이 실행중

#### Failed

트랜잭션 실패

#### Partially Committed

트랜잭션의 `Commit`명령이 도착한 상태. 트랜잭션의 `commit` 이전 `sql` 문이 수행되고 `commit`만 남은 상태

#### Committed

트랜젝션 정상적으로 완료

#### Aborted

트랜잭션 취소. 실행 이전 데이터로 돌아간 상태

#### Partially Commited 와 Commited의 차이점

`commit`요청이 들어오면 `partial commited` 상태가 된다. 이후 `commit`을 문제 없이 수행할 수 있으면 `commited` 상태로 전이되고, 오류가 발생하면 `Failed` 상태가 된다.



### 트랜젝션 사용시 주의점

꼭 필요한 최소의 코드에만 적용.

일반적으로 DB 커넥션은 개수가 제한적. 각 단위 프로그램이 커넥션 소유하는 시간이 길어지면 사용 가능한 여유 커넥션의 개수는 줄어든다. 어느 순간에 각 프로그램이 커넥션을 가져가기 위해 기다려야 할 수도 있다.



### 교착상태

> 트랜젝션 여러개 사용하다 보면 교착상태 발생.
>
> 2개 이상의 트랜젝션이 특정 자원의 Lock을 획득한 채 다른 트랜젝션이 소유한 잠금을 요구하면 아무리 기다려도 상황이 바뀌지 않는데, 이를 교착상태라 한다.



#### 교착 상태의 빈도를 낮추는 방법

- 트랜젝션 자주 커밋
- 정해진 순서로 테이블에 접근
- 읽기 잠금 획득의 사용을 피한다.
- 한 테이블의 복수 행을 복수의 연결에서 순서 없이 갱신하면 교착상태 자주 발생. 테이블 단위의 잠금을 획득해 갱신을 직렬화 하면 동시성 떨어지지만 교착상태 회피 가능

